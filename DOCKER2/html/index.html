<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shop ƒê·ªì C√¥ng ngh·ªá c·ªßa Ly</title>
    <style>
      /* CSS C∆† B·∫¢N & SHOPEE COLOR PALETTE */
      :root {
        --primary-color: #ee4d2d; /* M√†u cam Shopee */
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --light-bg: #f5f5f5; /* N·ªÅn x√°m nh·∫°t */
        --card-bg: #ffffff;
        --text-color: #333;
        --border-color: #e5e5e5;
        --transition: all 0.2s ease-in-out;
      }
      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background-color: var(--light-bg);
        margin: 0;
        padding: 0;
        color: var(--text-color);
      }
      * {
        box-sizing: border-box;
      }
      .hidden {
        display: none !important;
      }

      /* --- AUTH CONTAINER (Giao di·ªán ƒëƒÉng nh·∫≠p) --- */
      #auth-container {
        max-width: 400px;
        margin: 10vh auto;
        background: var(--card-bg);
        padding: 2rem;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .form h2 {
        text-align: center;
        color: var(--primary-color);
        font-weight: 500;
        margin-bottom: 1.5rem;
      }
      .form-group input {
        border: 1px solid var(--border-color);
        border-radius: 2px;
        width: 100%;
        padding: 0.75rem;
      }
      .form-button {
        width: 100%;
        padding: 0.75rem;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 2px;
        transition: var(--transition);
        font-weight: 500;
        cursor: pointer;
      }
      .form-button:hover {
        opacity: 0.9;
      }
      .toggle-link a {
        color: var(--primary-color);
        cursor: pointer;
      }
      #message-area {
        border: 1px solid var(--border-color);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        text-align: center;
      }
      #message-area.success {
        background-color: #e6ffed;
        color: var(--success-color);
      }
      #message-area.error {
        background-color: #ffeaea;
        color: var(--danger-color);
      }

      /* --- HEADER (Rep Shopee) --- */
      #app-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 50;
        padding: 1rem 0;
        background: var(--primary-color);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        color: white;
      }
      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 30px;
        padding: 0 20px;
      }
      .header-content h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: bold;
        color: white;
      }
      .search-bar-container {
        flex-grow: 1;
        display: flex;
        align-items: center;
      }
      .search-bar {
        width: 100%;
        position: relative;
      }
      #search-box-header {
        width: 100%;
        padding: 8px 15px;
        border: none;
        border-radius: 2px;
        font-size: 0.9rem;
        background-color: white;
      }
      .search-button {
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        width: 50px;
        background-color: #f8f8f8;
        color: var(--primary-color);
        border: none;
        cursor: pointer;
        border-radius: 0 2px 2px 0;
        padding: 0;
      }
      #cart-icon-button {
        color: white !important;
        font-size: 2.2rem;
        transition: var(--transition);
        padding: 0 10px;
        background: none;
        border: none;
        cursor: pointer;
      }
      #cart-count {
        background: white;
        color: var(--primary-color);
        padding: 2px 5px;
        border-radius: 50%;
        font-size: 0.75rem !important;
        position: relative;
        top: -15px;
        left: -10px;
        font-weight: bold;
      }
      #logout-button {
        background: none;
        border: 1px solid white;
        padding: 0.5rem 1rem;
        color: white;
        border-radius: 2px;
        font-size: 0.9rem;
        transition: var(--transition);
        cursor: pointer;
      }
      #logout-button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      /* --- PRODUCTS & FILTERS --- */
      .products-section {
        padding: 0 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .filters {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 2rem;
        background: var(--card-bg);
        padding: 1rem;
        border-radius: 2px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
      }
      .filters select {
        width: 100%;
        padding: 0.75rem;
        border-radius: 2px;
        border: 1px solid var(--border-color);
        font-size: 0.9rem;
      }

      /* Product List */
      #product-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 12px;
        margin-bottom: 2rem;
      }
      .product-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 2px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.2s, transform 0.2s;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .product-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-bottom: 1px solid var(--border-color);
        background-color: #eee;
      }
      .product-info {
        padding: 0.75rem;
        flex-grow: 1;
      }
      .product-info h3 {
        font-size: 0.9rem;
        height: 36px;
        overflow: hidden;
        margin: 0 0 0.5rem 0;
      }
      .product-info p {
        color: var(--primary-color);
        font-size: 1.1rem;
        font-weight: bold;
      }
      .product-card button {
        background-color: var(--primary-color);
        font-size: 0.9rem;
        padding: 0.5rem;
      }
      .product-card button:hover {
        background-color: #ff5e3d;
      }

      /* --- SIDE PANEL (CART) --- */
      .cart-section {
        position: fixed;
        top: 0;
        right: 0;
        width: 380px;
        height: 100%;
        background: var(--card-bg);
        padding: 20px;
        box-shadow: -6px 0 15px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        display: block !important;
      }
      .cart-section.open {
        transform: translateX(0);
      }
      .cart-section h2 {
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        margin-bottom: 15px;
        font-weight: 500;
      }
      #close-cart-button {
        color: var(--secondary-color);
      }

      .cart-items-wrapper {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
      }
      .cart-item {
        border-bottom: 1px solid var(--border-color);
        padding: 0.75rem 0;
        align-items: flex-start;
      }
      .cart-item-name {
        flex-basis: 40%;
        font-size: 0.9rem;
      }
      .cart-controls {
        gap: 0.5rem;
      }
      .cart-qty-btn {
        width: 25px;
        height: 25px;
        border-radius: 2px;
        font-weight: bold;
        font-size: 1rem;
      }
      .cart-remove-btn {
        color: var(--danger-color);
        font-size: 1rem;
      }
      #proceed-to-checkout {
        background-color: var(--primary-color);
      }
      #continue-shopping {
        background-color: var(--secondary-color);
      }

      /* --- CHECKOUT VIEW --- */
      #checkout-view {
        padding: 0 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      #checkout-view h2 {
        color: var(--primary-color);
        font-weight: 500;
        text-align: center;
        margin-top: 1rem;
      }
      #shipping-form {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: none !important;
        border-radius: 4px !important;
      }
      #checkout-summary h4 {
        color: var(--primary-color);
        font-weight: 500;
      }
      #place-order-button {
        background-color: var(--primary-color);
      }
      #back-to-cart-button {
        background-color: var(--secondary-color);
      }
    </style>
  </head>
  <body>
    <div class="container" id="auth-container">
      <div id="message-area" class="hidden"></div>
      <form id="login-form" class="form">
        <h2>ƒêƒÉng Nh·∫≠p</h2>
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" required />
        </div>
        <div class="form-group">
          <label for="login-password">M·∫≠t kh·∫©u</label>
          <input type="password" id="login-password" required />
        </div>
        <button type="submit" class="form-button">ƒêƒÉng Nh·∫≠p</button>
        <p class="toggle-link">
          Ch∆∞a c√≥ t√†i kho·∫£n? <a id="show-register">ƒêƒÉng k√Ω ngay</a>
        </p>
      </form>
      <form id="register-form" class="form hidden">
        <h2>ƒêƒÉng K√Ω</h2>
        <div class="form-group">
          <label for="register-name">H·ªç v√† T√™n</label>
          <input type="text" id="register-name" required />
        </div>
        <div class="form-group">
          <label for="register-email">Email</label>
          <input type="email" id="register-email" required />
        </div>
        <div class="form-group">
          <label for="register-password">M·∫≠t kh·∫©u</label>
          <input type="password" id="register-password" required />
        </div>
        <button type="submit" class="form-button">ƒêƒÉng K√Ω</button>
        <p class="toggle-link">
          ƒê√£ c√≥ t√†i kho·∫£n? <a id="show-login">ƒêƒÉng nh·∫≠p</a>
        </p>
      </form>
    </div>

    <div id="app-container" class="hidden">
      <header>
        <div class="header-content">
          <h1>LyLy Shop</h1>

          <div class="search-bar-container">
            <div class="search-bar">
              <input
                type="search"
                id="search-box-header"
                placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m tr√™n Shop ƒë·ªì c√¥ng ngh·ªá c·ªßa Ly..."
                onkeydown="if(event.key === 'Enter') { fetchProducts(); }"
              />
              <button
                type="button"
                class="search-button"
                onclick="fetchProducts();"
              >
                üîç
              </button>
            </div>
          </div>

          <div style="display: flex; align-items: center; gap: 20px">
            <div id="user-info"></div>
            <div id="admin-button-container"></div>
            <button id="cart-icon-button">
              üõí <span id="cart-count"> (0)</span>
            </button>
            <button id="logout-button">ƒêƒÉng Xu·∫•t</button>
          </div>
        </div>
      </header>

      <div class="main-content-wrapper">
    <div class="products-section" id="products-view">
        <div class="filters">
            <select id="category-filter">
                <option value="all">T·∫•t c·∫£ danh m·ª•c</option>
            </select>
        </div>

        <div id="product-list"></div>
    </div>

    <div id="checkout-view" class="hidden">
        <h2>Th√¥ng tin giao h√†ng v√† Thanh to√°n</h2>
        <div id="checkout-summary"></div>

        <form
            id="shipping-form"
            style="max-width: 600px; margin: 2rem auto; padding: 20px"
        >
            <div class="form-group">
                <label for="shipping-name">H·ªç t√™n ng∆∞·ªùi nh·∫≠n</label>
                <input type="text" id="shipping-name" required />
            </div>
            <div class="form-group">
                <label for="shipping-phone">S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="tel" id="shipping-phone" required />
            </div>
            <div class="form-group">
                <label for="shipping-address">ƒê·ªãa ch·ªâ</label>
                <input type="text" id="shipping-address" required />
            </div>
            <button type="submit" id="place-order-button" class="form-button">
                X√°c nh·∫≠n ƒê·∫∑t H√†ng
            </button>
            <button
                type="button"
                id="back-to-cart-button"
                class="form-button"
                style="background-color: var(--secondary-color); margin-top: 10px"
            >
                Quay l·∫°i Gi·ªè h√†ng
            </button>
        </form>
    </div>
    
    <div id="admin-view" class="hidden">
        <h2 style="color: var(--primary-color); text-align: center;">üõ°Ô∏è B·∫¢NG ƒêI·ªÄU KHI·ªÇN ADMIN</h2>
        <div 
            style="max-width: 800px; margin: 2rem auto; padding: 20px; background: white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.08);"
        >
            <h3>üìä Th·ªëng k√™ nhanh</h3>
            <div id="order-stats-result">
                ƒêang t·∫£i th·ªëng k√™ ƒë∆°n h√†ng...
            </div>
            <h3 style="margin-top: 30px;">üìã Danh s√°ch ƒê∆°n h√†ng</h3>
            <div id="admin-order-list">
                 <p style="color: #666;">Danh s√°ch ƒë∆°n h√†ng chi ti·∫øt s·∫Ω ƒë∆∞·ª£c t·∫£i t·∫°i ƒë√¢y.</p>
            </div>
        </div>
    </div>
</div>

    <div id="cart-side-panel" class="cart-section hidden">
      <button id="close-cart-button" style="float: right; font-size: 1.5rem">
        &times;
      </button>
      <h2>üõí Gi·ªè H√†ng c·ªßa b·∫°n</h2>
      <div class="cart-items-wrapper">
        <ul id="cart-items-list"></ul>
      </div>

      <div
        id="cart-total"
        style="
          text-align: right;
          border-top: 1px solid var(--border-color);
          padding-top: 10px;
          margin-top: 10px;
        "
      >
        T·ªïng ti·ªÅn: 0 ‚Ç´
      </div>

      <button id="proceed-to-checkout" class="form-button">
        Ti·∫øn h√†nh ƒê·∫∑t h√†ng
      </button>
      <button
        id="continue-shopping"
        class="form-button"
        style="background-color: var(--secondary-color); margin-top: 10px"
      >
        Ti·∫øp t·ª•c mua s·∫Øm
      </button>
    </div>

    <script>
      // JAVASCRIPT LOGIC

      // C·∫§U H√åNH API & GLOBAL CONST
      const API_BASE_URL = "http://localhost:1880";
      const PLACEHOLDER_IMG =
        "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3Cpath d='M0 0h1v1H0z' fill='%23eee'/%3E%3C/svg%3E";

      // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
      const authContainer = document.getElementById("auth-container");
      const appContainer = document.getElementById("app-container");
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const messageArea = document.getElementById("message-area");
      const showRegisterLink = document.getElementById("show-register");
      const showLoginLink = document.getElementById("show-login");
      const logoutButton = document.getElementById("logout-button");
      const userInfo = document.getElementById("user-info");
      const productList = document.getElementById("product-list");
      const categoryFilter = document.getElementById("category-filter");
      const searchBox = document.getElementById("search-box-header"); // Search box m·ªõi trong header
      const cartItemsList = document.getElementById("cart-items-list");
      const cartTotal = document.getElementById("cart-total");
      const shippingForm = document.getElementById("shipping-form");

      // DOM elements m·ªõi
      const cartSidePanel = document.getElementById("cart-side-panel");
      const cartIconButton = document.getElementById("cart-icon-button");
      const cartCount = document.getElementById("cart-count");
      const closeCartButton = document.getElementById("close-cart-button");
      const proceedToCheckoutButton = document.getElementById(
        "proceed-to-checkout"
      );
      const continueShoppingButton =
        document.getElementById("continue-shopping");
      const backToCartButton = document.getElementById("back-to-cart-button");
      const productsView = document.getElementById("products-view");
      const checkoutView = document.getElementById("checkout-view");
      const checkoutSummary = document.getElementById("checkout-summary");
      
      // TH√äM: Admin View DOM elements
      const adminView = document.getElementById("admin-view"); 
      const adminButtonContainer = document.getElementById("admin-button-container");
      const adminOrderList = document.getElementById("admin-order-list");
      const orderStatsResult = document.getElementById("order-stats-result");

      // Tr·∫°ng th√°i c·ªßa ·ª©ng d·ª•ng
      let state = {
        products: [],
        categories: [],
        cart: [],
        token: null,
        user: null,
        userRole: 0, // 0: Customer, 1: Admin
      };
      
      // --- H√ÄM TI·ªÜN √çCH & VIEW CONTROLLER ---

      function showMessage(message, isError = false) {
        messageArea.textContent = message;
        messageArea.className = isError ? "error" : "success";
      }

      function showAuthPage() {
        authContainer.classList.remove("hidden");
        appContainer.classList.add("hidden");
        // ƒê·∫£m b·∫£o n√∫t Admin b·ªã x√≥a khi ƒëƒÉng xu·∫•t
        adminButtonContainer.innerHTML = '';
        hideCartPanel();
      }

      async function showAppPage() {
        authContainer.classList.add("hidden");
        appContainer.classList.remove("hidden");
        await loadInitialData();
        checkUserRoleAndRenderHeader(); // G·ªåI H√ÄM KI·ªÇM TRA ROLE V√Ä RENDER N√öT
        showPage('products-view'); // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã trang s·∫£n ph·∫©m
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      function getToken() {
        return state.token || localStorage.getItem("userToken");
      }

      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }

      // Cart Panel View
      function showCartPanel() {
        cartSidePanel.classList.remove("hidden");
        cartSidePanel.classList.add("open");
        renderCart();
      }

      function hideCartPanel() {
        cartSidePanel.classList.remove("open");
      }

      // Main App Views - Refactored with showPage
      
      function showPage(viewId) {
          // ·∫®n t·∫•t c·∫£ c√°c view ch√≠nh trong main-content-wrapper
          document.querySelectorAll('.main-content-wrapper > div').forEach(view => {
              view.classList.add('hidden');
          });

          // Hi·ªán view ƒë∆∞·ª£c ch·ªçn
          const targetView = document.getElementById(viewId);
          if (targetView) {
              targetView.classList.remove('hidden');
          }
          
          // ƒê√≥ng cart panel
          hideCartPanel();
      }

      function showProductsView() {
        showPage('products-view');
      }

      function showCheckoutView() {
        showPage('checkout-view');
        renderCheckoutSummary();
      }

      // C·∫¨P NH·∫¨T: H√†m hi·ªÉn th·ªã trang Admin
      function showAdminView() {
          if (state.userRole === 1) {
              showPage('admin-view');
              fetchAdminData(); // G·ªåI H√ÄM T·∫¢I D·ªÆ LI·ªÜU ADMIN TH·ª∞C T·∫æ
          } else {
              alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.");
              showPage('products-view');
          }
      }
      
      // TH√äM: H√†m ki·ªÉm tra vai tr√≤ v√† render n√∫t Admin
      function checkUserRoleAndRenderHeader() {
          adminButtonContainer.innerHTML = ''; // X√≥a n√∫t c≈©

          if (state.userRole === 1) { // N·∫øu l√† Admin
              adminButtonContainer.innerHTML = `
                  <button 
                      id="show-admin-view-button" 
                      style="padding: 0.5rem 1rem; background-color: white; color: var(--primary-color); border: none; border-radius: 2px; font-size: 0.9rem; font-weight: 500; cursor: pointer;"
                  >
                      ‚öôÔ∏è Admin Panel
                  </button>
              `;
              // G√°n s·ª± ki·ªán cho n√∫t Admin
              document.getElementById("show-admin-view-button").addEventListener("click", showAdminView);
          }
      }

      function renderCheckoutSummary() {
        const totalAmount = state.cart.reduce(
          (total, item) => total + item.price * item.quantity,
          0
        );
        checkoutSummary.innerHTML = `
                <div style="background: #fff8f8; padding: 10px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #ffcccb;">
                    <h4>T√≥m t·∫Øt ƒë∆°n h√†ng:</h4>
                    ${state.cart
                      .map(
                        (item) => `
                        <p style="margin: 5px 0; display: flex; justify-content: space-between; font-size: 0.95rem;">
                            <span style="color: #666;">${item.name} x${
                          item.quantity
                        }</span>
                            <span style="color: var(--primary-color); font-weight: 500;">${formatCurrency(
                              item.price * item.quantity
                            )}</span>
                        </p>
                    `
                      )
                      .join("")}
                    <h4 style="border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between;">
                        <span>T·ªïng c·ªông (T·∫°m t√≠nh):</span>
                        <span style="color: var(--primary-color); font-size: 1.3rem;">${formatCurrency(
                          totalAmount
                        )}</span>
                    </h4>
                </div>
            `;
      }
      
      // --- C√ÅC H√ÄM RENDER CHO ADMIN VIEW (M·ªöI) ---
      
      function renderAdminStats(orders) {
          const totalOrders = orders.length;
          const totalRevenue = orders.reduce((sum, order) => sum + order.total_amount, 0);

          orderStatsResult.innerHTML = `
              <div style="display: flex; justify-content: space-around; gap: 20px; text-align: center;">
                  <div style="background: #e6f7ff; padding: 15px; border-radius: 4px; flex: 1;">
                      <h4 style="color: #0056b3; margin: 0 0 5px 0;">T·ªïng s·ªë ƒë∆°n h√†ng</h4>
                      <p style="font-size: 1.8rem; font-weight: bold; color: #0056b3;">${totalOrders}</p>
                  </div>
                  <div style="background: #e9ffea; padding: 15px; border-radius: 4px; flex: 1;">
                      <h4 style="color: var(--success-color); margin: 0 0 5px 0;">T·ªïng doanh thu</h4>
                      <p style="font-size: 1.8rem; font-weight: bold; color: var(--success-color);">${formatCurrency(totalRevenue)}</p>
                  </div>
              </div>
          `;
      }

      function renderAdminOrderList(orders) {
          if (orders.length === 0) {
              adminOrderList.innerHTML = '<p style="text-align: center; color: #666;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>';
              return;
          }

          const tableHTML = `
              <table style="width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem;">
                  <thead>
                      <tr style="background-color: var(--light-bg);">
                          <th style="padding: 10px; border: 1px solid var(--border-color); text-align: left;">M√£ ƒêH</th>
                          <th style="padding: 10px; border: 1px solid var(--border-color); text-align: left;">T·ªïng ti·ªÅn</th>
                          <th style="padding: 10px; border: 1px solid var(--border-color); text-align: left;">Ng∆∞·ªùi nh·∫≠n</th>
                          <th style="padding: 10px; border: 1px solid var(--border-color); text-align: left;">Ng√†y ƒë·∫∑t</th>
                          <th style="padding: 10px; border: 1px solid var(--border-color); text-align: left;">Chi ti·∫øt</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${orders.map(order => `
                          <tr>
                              <td style="padding: 10px; border: 1px solid var(--border-color); font-weight: bold;">#${order.order_id}</td>
                              <td style="padding: 10px; border: 1px solid var(--border-color); color: var(--primary-color); font-weight: 500;">${formatCurrency(order.total_amount)}</td>
                              <td style="padding: 10px; border: 1px solid var(--border-color);">${order.shipping_name}</td>
                              <td style="padding: 10px; border: 1px solid var(--border-color);">${new Date(order.created_at).toLocaleDateString('vi-VN')}</td>
                              <td style="padding: 10px; border: 1px solid var(--border-color);">
                                  <button onclick="alert('ƒê·ªãa ch·ªâ: ${order.shipping_address}\\nƒêi·ªán tho·∫°i: ${order.shipping_phone}\\n\\nS·∫£n ph·∫©m:\\n${order.items.map(item => `- ${item.product_name} x${item.quantity} (${formatCurrency(item.item_price)})`).join('\\n')}')"
                                      style="background: none; border: 1px solid var(--secondary-color); color: var(--secondary-color); padding: 5px 10px; cursor: pointer; border-radius: 2px;">
                                      Xem
                                  </button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;

          adminOrderList.innerHTML = tableHTML;
      }

      // --- LOGIC X·ª¨ L√ù CART (Gi·ªØ nguy√™n) ---

      function addToCart(productId) {
        let existingItem = state.cart.find(
          (item) => item.product_id === productId
        );

        if (existingItem) {
          existingItem.quantity++;
        } else {
          const product = state.products.find(
            (p) => p.product_id === productId
          );
          if (product) {
            state.cart.push({
              product_id: product.product_id,
              name: product.name,
              price: product.price,
              quantity: 1,
            });
          }
        }
        renderCart();
      }

      function updateCartQuantity(productId, action) {
        const id = parseInt(productId, 10);
        const itemIndex = state.cart.findIndex(
          (item) => item.product_id === id
        );

        if (itemIndex === -1) return;

        if (action === "increase") {
          state.cart[itemIndex].quantity++;
        } else if (action === "decrease") {
          state.cart[itemIndex].quantity--;

          if (state.cart[itemIndex].quantity <= 0) {
            state.cart.splice(itemIndex, 1);
          }
        } else if (action === "remove") {
          state.cart.splice(itemIndex, 1);
        }

        renderCart();
      }

      function renderCart() {
        cartItemsList.innerHTML = "";
        let total = 0;
        let totalItems = 0;

        if (state.cart.length === 0) {
          cartItemsList.innerHTML =
            "<li style='padding: 10px;'>Gi·ªè h√†ng tr·ªëng</li>";
          cartTotal.textContent = "T·ªïng ti·ªÅn: 0 ‚Ç´";
          cartCount.textContent = "(0)";
          return;
        }

        state.cart.forEach((item) => {
          const li = document.createElement("li");
          li.className = "cart-item";

          li.innerHTML = `
                    <span class="cart-item-name">${item.name}</span>
                    <div class="cart-controls">
                        <button class="cart-qty-btn" data-id="${
                          item.product_id
                        }" data-action="decrease">-</button>
                        <span class="cart-item-qty-display">${
                          item.quantity
                        }</span>
                        <button class="cart-qty-btn" data-id="${
                          item.product_id
                        }" data-action="increase">+</button>
                        <button class="cart-remove-btn" data-id="${
                          item.product_id
                        }">‚ùå</button>
                    </div>
                    <span class="cart-item-price">${formatCurrency(
                      item.price * item.quantity
                    )}</span>
                `;
          cartItemsList.appendChild(li);
          total += item.price * item.quantity;
          totalItems += item.quantity;
        });

        cartTotal.textContent = `T·ªïng ti·ªÅn: ${formatCurrency(total)}`;
        cartCount.textContent = `(${totalItems})`;
      }

      // --- X·ª¨ L√ù API (E-COMMERCE) ---

      async function loadInitialData() {
        await fetchCategories();
        await fetchProducts();
      }

      async function fetchCategories() {
        try {
          const res = await fetch(`${API_BASE_URL}/api/categories`);
          state.categories = await res.json();
          renderCategories();
        } catch (err) {
          console.error("L·ªói fetchCategories:", err);
        }
      }

      async function fetchProducts() {
        // L·∫•y gi√° tr·ªã t√¨m ki·∫øm t·ª´ header search box
        const category = categoryFilter.value;
        const search = searchBox.value;

        let query = new URLSearchParams();
        if (category && category !== "all") {
          query.append("category_id", category);
        }
        if (search) {
          query.append("search", search);
        }

        try {
          const res = await fetch(
            `${API_BASE_URL}/api/products?${query.toString()}`
          );
          state.products = await res.json();
          renderProducts();
        } catch (err) {
          console.error("L·ªói fetchProducts:", err);
        }
      }

      // TH√äM: H√ÄM T·∫¢I D·ªÆ LI·ªÜU ADMIN (M·ªöI)
      async function fetchAdminData() {
          orderStatsResult.innerHTML = 'ƒêang t·∫£i th·ªëng k√™ ƒë∆°n h√†ng...';
          adminOrderList.innerHTML = 'ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...';

          try {
              const res = await fetch(`${API_BASE_URL}/api/admin/orders`, {
                  method: "GET",
                  headers: {
                      "Authorization": `Bearer ${getToken()}`
                  }
              });

              const orders = await res.json();

              if (res.status === 403) {
                  adminOrderList.innerHTML = '<p style="color: var(--danger-color); text-align: center;">üõ°Ô∏è L·ªói 403: B·∫°n kh√¥ng c√≥ quy·ªÅn Admin ƒë·ªÉ truy c·∫≠p.</p>';
                  orderStatsResult.innerHTML = '';
                  return;
              }
              
              if (!res.ok) {
                   throw new Error(orders.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi t·∫£i d·ªØ li·ªáu admin.");
              }

              // S·ª¨ D·ª§NG D·ªÆ LI·ªÜU ƒê·ªÇ RENDER
              renderAdminStats(orders);
              renderAdminOrderList(orders);

          } catch (err) {
              console.error("L·ªói fetchAdminData:", err);
              adminOrderList.innerHTML = `<p style="color: var(--danger-color); text-align: center;">L·ªói: ${err.message || 'L·ªói k·∫øt n·ªëi server ho·∫∑c l·ªói d·ªØ li·ªáu.'}</p>`;
              orderStatsResult.innerHTML = '';
          }
      }


      shippingForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (state.cart.length === 0) {
          alert("Gi·ªè h√†ng c·ªßa b·∫°n ƒëang r·ªóng!");
          return;
        }

        const body = {
          shipping: {
            name: document.getElementById("shipping-name").value,
            phone: document.getElementById("shipping-phone").value,
            address: document.getElementById("shipping-address").value,
          },
          cart: state.cart.map((item) => ({
            product_id: item.product_id,
            quantity: item.quantity,
            price: item.price,
          })),
          total_amount: state.cart.reduce(
            (total, item) => total + item.price * item.quantity,
            0
          ),
        };

        try {
          const res = await fetch(`${API_BASE_URL}/api/orders`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
            body: JSON.stringify(body),
          });

          const data = await res.json();

          if (data.success) {
            alert(
              `ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${data.order_id}. Ch√∫c b·∫°n c√≥ tr·∫£i nghi·ªám mua s·∫Øm vui v·∫ª!`
            );
            state.cart = [];
            renderCart();
            shippingForm.reset();
            showProductsView(); // Quay l·∫°i trang s·∫£n ph·∫©m
          } else {
            alert(`L·ªói: ${data.message}`);
          }
        } catch (err) {
          alert("L·ªói server. Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng.");
        }
      });

      // --- X·ª¨ L√ù RENDER GIAO DI·ªÜN (Gi·ªØ nguy√™n logic) ---

      function renderCategories() {
        categoryFilter.innerHTML =
          '<option value="all">T·∫•t c·∫£ danh m·ª•c</option>';
        state.categories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.category_id;
          option.textContent = cat.name;
          categoryFilter.appendChild(option);
        });
      }

      function renderProducts() {
        productList.innerHTML = "";
        if (state.products.length === 0) {
          productList.innerHTML =
            "<p style='padding: 20px; text-align: center; color: #666;'>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</p>";
          return;
        }

        state.products.forEach((product) => {
          const card = document.createElement("div");
          card.className = "product-card";

          card.innerHTML = `
                    <img src="${product.image_url || PLACEHOLDER_IMG}" 
                         alt="${product.name}" 
                         onerror="this.onerror=null; this.src='${PLACEHOLDER_IMG}';">
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <p>${formatCurrency(product.price)}</p>
                    </div>
                    <button class="add-to-cart-btn" data-id="${
                      product.product_id
                    }">
                        Th√™m v√†o gi·ªè
                    </button>
                `;
          productList.appendChild(card);
        });
      }

      // --- X·ª¨ L√ù EVENTS (Gi·ªØ nguy√™n logic) ---

      // AUTH EVENTS
      showRegisterLink.addEventListener("click", () => {
        loginForm.classList.add("hidden");
        registerForm.classList.remove("hidden");
        messageArea.className = "hidden";
      });
      showLoginLink.addEventListener("click", () => {
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
        messageArea.className = "hidden";
      });
      logoutButton.addEventListener("click", () => {
        localStorage.removeItem("userToken");
        state.token = null;
        state.user = null;
        state.userRole = 0; // RESET VAI TR√í
        state.cart = [];
        renderCart();
        showAuthPage();
      });

      // PRODUCT/FILTER EVENTS
      categoryFilter.addEventListener("change", fetchProducts);

      productList.addEventListener("click", (e) => {
        if (e.target.classList.contains("add-to-cart-btn")) {
          const productId = parseInt(e.target.dataset.id, 10);
          addToCart(productId);
        }
      });

      // CART CONTROL EVENTS
      cartIconButton.addEventListener("click", showCartPanel);
      closeCartButton.addEventListener("click", hideCartPanel);
      continueShoppingButton.addEventListener("click", hideCartPanel);
      // backToCartButton.addEventListener("click", showProductsView); // ƒê√£ s·ª≠ d·ª•ng showProductsView m·ªõi
      backToCartButton.addEventListener("click", () => showPage('products-view'));


      // B·∫•m "Ti·∫øn h√†nh ƒê·∫∑t h√†ng" (Chuy·ªÉn sang Form Thanh to√°n)
      proceedToCheckoutButton.addEventListener("click", () => {
        if (state.cart.length === 0) {
          alert("Gi·ªè h√†ng c·ªßa b·∫°n ƒëang r·ªóng!");
          return;
        }
        showCheckoutView();
      });

      // Event Listener cho Gi·ªè h√†ng (B·∫Øt s·ª± ki·ªán click v√†o n√∫t +/-/X)
      cartItemsList.addEventListener("click", (e) => {
        const target = e.target;
        const productId = target.dataset.id;

        if (!productId) return;

        if (target.classList.contains("cart-qty-btn")) {
          const action = target.dataset.action;
          updateCartQuantity(productId, action);
        } else if (target.classList.contains("cart-remove-btn")) {
          updateCartQuantity(productId, "remove");
        }
      });

      // --- KH·ªûI CH·∫†Y ---
      // Ki·ªÉm tra xem user ƒë√£ ƒëƒÉng nh·∫≠p t·ª´ tr∆∞·ªõc ch∆∞a
      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("userToken");
        if (token) {
          state.token = token;
          state.user = parseJwt(token);
          // THAY ƒê·ªîI: Ph√¢n t√≠ch vai tr√≤ ng∆∞·ªùi d√πng khi kh·ªüi ƒë·ªông
          state.userRole = state.user && state.user.role === 'admin' ? 1 : 0; 
          userInfo.textContent = `Ch√†o, ${state.user.full_name}`;
          showAppPage();
        } else {
          showAuthPage();
        }
      });

      // --- AUTH API HANDLERS (ƒê√£ ch·ªânh s·ª≠a logic ƒëƒÉng nh·∫≠p) ---

      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const body = {
          full_name: document.getElementById("register-name").value,
          email: document.getElementById("register-email").value,
          password: document.getElementById("register-password").value,
        };

        try {
          const res = await fetch(`${API_BASE_URL}/register-insecure`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          if (data.success) {
            showMessage("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.", false);
            showLoginLink.click();
          } else {
            showMessage(data.message, true);
          }
        } catch (err) {
          showMessage("L·ªói k·∫øt n·ªëi server.", true);
        }
      });

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const body = {
          email: document.getElementById("login-email").value,
          password: document.getElementById("login-password").value,
        };

        try {
          const res = await fetch(`${API_BASE_URL}/login-insecure`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          if (data.success) {
            state.token = data.token;
            state.user = parseJwt(data.token);
            localStorage.setItem("userToken", data.token);
            // THAY ƒê·ªîI: Ph√¢n t√≠ch v√† g√°n vai tr√≤ ng∆∞·ªùi d√πng
            state.userRole = state.user && state.user.role === 'admin' ? 1 : 0;
            
            userInfo.textContent = `Ch√†o, ${state.user.full_name}`;
            await showAppPage();
          } else {
            showMessage(data.message, true);
          }
        } catch (err) {
          showMessage("L·ªói k·∫øt n·ªëi server.", true);
        }
      });
    </script>
  </body>
</html>